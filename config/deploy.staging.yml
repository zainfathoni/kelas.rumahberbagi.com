# Kamal 2.0 deployment configuration for Kelas Rumah Berbagi (Staging)
# See: https://kamal-deploy.org/docs/configuration/

service: kelas-staging

# Docker image configuration
image: zainfathoni/kelas.rumahberbagi.com

# Deployment servers
servers:
  web:
    hosts:
      - 103.235.75.227
    options:
      volume:
        - /data/kelas-staging/db:/app/prisma

# Container registry (GitHub Container Registry)
registry:
  server: ghcr.io
  username: zainfathoni
  password:
    - KAMAL_REGISTRY_PASSWORD

# Kamal Proxy configuration (replaces Traefik in Kamal 2.0)
proxy:
  ssl: true
  host: staging.kelas.rumahberbagi.com
  app_port: 3000
  healthcheck:
    path: /
    interval: 5
    timeout: 5

# Environment variables
env:
  # Clear (non-secret) environment variables
  clear:
    NODE_ENV: production
    PORT: "3000"
    DATABASE_URL: file:/app/prisma/staging.db
    STAGING_ENVIRONMENT: "true"
    EMAIL_FROM: Rumah Berbagi Staging <staging@rumahberbagi.com>
  # Secret environment variables (loaded from .kamal/secrets)
  secret:
    - SESSION_SECRET
    - MAGIC_LINK_SECRET
    - MAILGUN_SENDING_KEY
    - MAILGUN_DOMAIN

# Build configuration
builder:
  arch: amd64
  args:
    NODE_ENV: production

# Asset bridge for zero-downtime deployments
# Copies public assets from old container to new one during deploy
asset_path: /app/public
